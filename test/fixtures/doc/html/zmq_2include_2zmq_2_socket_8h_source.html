<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>lubyk: /Users/gaspard/git/lubyk/modules/zmq/include/zmq/Socket.h Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">lubyk
   &#160;<span id="projectnumber">0.5</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">/Users/gaspard/git/lubyk/modules/zmq/include/zmq/Socket.h</div>  </div>
</div>
<div class="contents">
<a href="zmq_2include_2zmq_2_socket_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">  ==============================================================================</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   This file is part of the LUBYK project (http://lubyk.org)</span>
<a name="l00005"></a>00005 <span class="comment">   Copyright (c) 2007-2011 by Gaspard Bucher (http://teti.ch).</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">  ------------------------------------------------------------------------------</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">   Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a name="l00010"></a>00010 <span class="comment">   of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<a name="l00011"></a>00011 <span class="comment">   in the Software without restriction, including without limitation the rights</span>
<a name="l00012"></a>00012 <span class="comment">   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<a name="l00013"></a>00013 <span class="comment">   copies of the Software, and to permit persons to whom the Software is</span>
<a name="l00014"></a>00014 <span class="comment">   furnished to do so, subject to the following conditions:</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">   The above copyright notice and this permission notice shall be included in</span>
<a name="l00017"></a>00017 <span class="comment">   all copies or substantial portions of the Software.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a name="l00020"></a>00020 <span class="comment">   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a name="l00021"></a>00021 <span class="comment">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a name="l00022"></a>00022 <span class="comment">   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a name="l00023"></a>00023 <span class="comment">   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<a name="l00024"></a>00024 <span class="comment">   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<a name="l00025"></a>00025 <span class="comment">   THE SOFTWARE.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">  ==============================================================================</span>
<a name="l00028"></a>00028 <span class="comment">*/</span>
<a name="l00029"></a>00029 <span class="preprocessor">#ifndef LUBYK_INCLUDE_ZMQ_SOCKET_H_</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#define LUBYK_INCLUDE_ZMQ_SOCKET_H_</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;../vendor/include/zmq.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="msgpack_8h.html">lubyk/msgpack.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="time__ref_8h.html">lubyk/time_ref.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;lubyk.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span> <span class="comment">// rand()</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;time.h&gt;</span>   <span class="comment">// time()</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">using namespace </span>lubyk;
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="zmq_2include_2zmq_2_socket_8h.html#ad7b7b6ae22c7c96907552b935952aed0">00044</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="zmq_2include_2zmq_2_socket_8h.html#ad7b7b6ae22c7c96907552b935952aed0">ZMQ_Socket</a> <a class="code" href="zmq_2include_2zmq_2_socket_8h.html#ad7b7b6ae22c7c96907552b935952aed0">ZMQ_Socket</a>;
<a name="l00045"></a>00045 <span class="keyword">namespace </span>zmq {
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">class </span>Poller;
<a name="l00054"></a><a class="code" href="classzmq_1_1_socket.html">00054</a> <span class="keyword">class </span><a class="code" href="classzmq_1_1_socket.html">Socket</a> : <span class="keyword">public</span> <a class="code" href="classlubyk_1_1_lua_object.html">LuaObject</a>
<a name="l00055"></a>00055 {
<a name="l00056"></a><a class="code" href="classzmq_1_1_socket.html#a6368feb544053a5a867a590000aeb1de">00056</a>   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classzmq_1_1_poller.html">Poller</a>;
<a name="l00057"></a><a class="code" href="classzmq_1_1_socket.html#a069f600701355be727b06d9f2dd7f976">00057</a>   <span class="keywordtype">void</span> *<a class="code" href="classzmq_1_1_socket.html#a069f600701355be727b06d9f2dd7f976">socket_</a>;
<a name="l00058"></a><a class="code" href="classzmq_1_1_socket.html#ab9140c21bb2248b528acac9670634675">00058</a>   std::string <a class="code" href="classzmq_1_1_socket.html#ab9140c21bb2248b528acac9670634675">location_</a>;
<a name="l00059"></a><a class="code" href="classzmq_1_1_socket.html#ad4347e6eaf983accf60cfb5aed31020b">00059</a>   <span class="keywordtype">int</span> <a class="code" href="classzmq_1_1_socket.html#ad4347e6eaf983accf60cfb5aed31020b">type_</a>;
<a name="l00060"></a><a class="code" href="classzmq_1_1_socket.html#a2494e6be34e6491248e3fc9aae01e79c">00060</a>   <span class="keywordtype">int</span> <a class="code" href="classzmq_1_1_socket.html#a2494e6be34e6491248e3fc9aae01e79c">send_flags_</a>;
<a name="l00061"></a>00061 
<a name="l00064"></a><a class="code" href="classzmq_1_1_socket.html#a2a1ea503ff3a43dd8982e9b105fcea50">00064</a>   <a class="code" href="classlubyk_1_1_time_ref.html">TimeRef</a> <a class="code" href="classzmq_1_1_socket.html#a2a1ea503ff3a43dd8982e9b105fcea50">time_ref_</a>;
<a name="l00065"></a>00065 <span class="keyword">public</span>:
<a name="l00070"></a><a class="code" href="classzmq_1_1_socket.html#ab20b347056a6dcb162f3deef4ac2a63c">00070</a>   <a class="code" href="classzmq_1_1_socket.html">Socket</a>(<span class="keywordtype">int</span> <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>, <a class="code" href="classlubyk_1_1_worker.html">lubyk::Worker</a> *worker)
<a name="l00071"></a>00071       : type_(type)
<a name="l00072"></a>00072       , send_flags_(0) 
<a name="l00073"></a>00073   {
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="keywordflow">if</span> (!worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a4068e8972c5fce50a60aaf9b37c614fa">zmq_context_</a>) {
<a name="l00076"></a>00076       <span class="comment">// initialize zmq context</span>
<a name="l00077"></a>00077       worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a4068e8972c5fce50a60aaf9b37c614fa">zmq_context_</a> = zmq_init(1);
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079     ++worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a0bc70f22a0ef1b6599639171828b590b">zmq_context_refcount_</a>;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     socket_ = zmq_socket(worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a4068e8972c5fce50a60aaf9b37c614fa">zmq_context_</a>, type_);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordflow">if</span> (!socket_) {
<a name="l00084"></a>00084       <span class="keywordflow">if</span> (!--worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a0bc70f22a0ef1b6599639171828b590b">zmq_context_refcount_</a>) {
<a name="l00085"></a>00085         zmq_term(worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a4068e8972c5fce50a60aaf9b37c614fa">zmq_context_</a>);
<a name="l00086"></a>00086         worker-&gt;<a class="code" href="classlubyk_1_1_worker.html#a4068e8972c5fce50a60aaf9b37c614fa">zmq_context_</a> = NULL;
<a name="l00087"></a>00087       }
<a name="l00088"></a>00088       <span class="keywordflow">switch</span> (errno) {
<a name="l00089"></a>00089       <span class="keywordflow">case</span> EINVAL:
<a name="l00090"></a>00090         <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Invalid socket type: %i).&quot;</span>, type_);
<a name="l00091"></a>00091       <span class="keywordflow">case</span> EMTHREAD:
<a name="l00092"></a>00092         <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The maximum number of sockets within this context has been exceeded.&quot;</span>);
<a name="l00093"></a>00093       <span class="keywordflow">case</span> EFAULT: <span class="comment">// continue</span>
<a name="l00094"></a>00094       <span class="keywordflow">default</span>:
<a name="l00095"></a>00095         <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The provided context was not valid.&quot;</span>);
<a name="l00096"></a>00096       }
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098   }
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="classzmq_1_1_socket.html#a2844b4299a3e410d88832943b4c6524f">00100</a>   <a class="code" href="classzmq_1_1_socket.html#a2844b4299a3e410d88832943b4c6524f">~Socket</a>() {
<a name="l00101"></a>00101     zmq_close(socket_);
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (!--worker_-&gt;zmq_context_refcount_) {
<a name="l00103"></a>00103       zmq_term(worker_-&gt;zmq_context_);
<a name="l00104"></a>00104       worker_-&gt;zmq_context_ = NULL;
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106   }
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="classzmq_1_1_socket.html#a6913e6251911ecb39c2d03638e72f3a3">00108</a>   <span class="keywordtype">int</span> <a class="code" href="classzmq_1_1_socket.html#a6913e6251911ecb39c2d03638e72f3a3">fd</a>() {
<a name="l00109"></a>00109     <span class="keywordtype">int</span> fd;
<a name="l00110"></a>00110     <span class="keywordtype">size_t</span> fd_size = <span class="keyword">sizeof</span>(fd);
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (zmq_getsockopt(socket_, ZMQ_FD, &amp;fd, &amp;fd_size)) {
<a name="l00112"></a>00112       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Error while getting file descriptor (%s).&quot;</span>, zmq_strerror(zmq_errno()));
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114     <span class="keywordflow">return</span> fd;
<a name="l00115"></a>00115   }
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="classzmq_1_1_socket.html#ab85fbea3c413a711e0ac6589448fb466">00117</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#ab85fbea3c413a711e0ac6589448fb466">setNonBlocking</a>(<span class="keywordtype">bool</span> non_blocking) {
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (non_blocking) {
<a name="l00119"></a>00119       send_flags_ |= ZMQ_NOBLOCK;
<a name="l00120"></a>00120     } <span class="keywordflow">else</span> {
<a name="l00121"></a>00121       send_flags_ &amp;= ~ZMQ_NOBLOCK;
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124 
<a name="l00127"></a><a class="code" href="classzmq_1_1_socket.html#ad7a88861054408143e59724dd87f6b5e">00127</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#ad7a88861054408143e59724dd87f6b5e">setsockopt</a>(<span class="keywordtype">int</span> <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>, lua_State *L) {
<a name="l00128"></a>00128     uint64_t ui;
<a name="l00129"></a>00129     int64_t  li;
<a name="l00130"></a>00130     <span class="keywordtype">int</span>      i;
<a name="l00131"></a>00131     <span class="keywordtype">size_t</span>   sz;
<a name="l00132"></a>00132     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cxcore_8h.html#a5f3a65d240411b0018990ff992b348c0">str</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="comment">// &lt;self&gt; &lt;type&gt; &lt;value&gt;</span>
<a name="l00135"></a>00135     <span class="keywordtype">int</span> <a class="code" href="cv_8h.html#ae17b3c2584dab511e91d1c96644018bf">status</a>;
<a name="l00136"></a>00136     <span class="keywordflow">switch</span>(type) {
<a name="l00137"></a>00137       <span class="keywordflow">case</span> ZMQ_HWM:    <span class="comment">// continue</span>
<a name="l00138"></a>00138       <span class="keywordflow">case</span> ZMQ_SNDBUF: <span class="comment">// continue</span>
<a name="l00139"></a>00139       <span class="keywordflow">case</span> ZMQ_RCVBUF:
<a name="l00140"></a>00140         ui = luaL_checknumber(L, 3);
<a name="l00141"></a>00141         status = zmq_setsockopt(socket_, type, &amp;ui, <span class="keyword">sizeof</span>(ui));
<a name="l00142"></a>00142         <span class="keywordflow">break</span>;
<a name="l00143"></a>00143       <span class="keywordflow">case</span> ZMQ_SWAP:  <span class="comment">// continue</span>
<a name="l00144"></a>00144       <span class="keywordflow">case</span> ZMQ_RATE:  <span class="comment">// continue</span>
<a name="l00145"></a>00145       <span class="keywordflow">case</span> ZMQ_RECOVERY_IVL: <span class="comment">// continue</span>
<a name="l00146"></a>00146       <span class="keywordflow">case</span> ZMQ_RECOVERY_IVL_MSEC:
<a name="l00147"></a>00147       <span class="keywordflow">case</span> ZMQ_MCAST_LOOP:
<a name="l00148"></a>00148         li = luaL_checknumber(L, 3);
<a name="l00149"></a>00149         status = zmq_setsockopt(socket_, type, &amp;li, <span class="keyword">sizeof</span>(li));
<a name="l00150"></a>00150         <span class="keywordflow">break</span>;
<a name="l00151"></a>00151       <span class="keywordflow">case</span> ZMQ_LINGER: <span class="comment">// continue</span>
<a name="l00152"></a>00152       <span class="keywordflow">case</span> ZMQ_RECONNECT_IVL: <span class="comment">// continue</span>
<a name="l00153"></a>00153       <span class="keywordflow">case</span> ZMQ_RECONNECT_IVL_MAX:
<a name="l00154"></a>00154         i = luaL_checknumber(L, 3);
<a name="l00155"></a>00155         status = zmq_setsockopt(socket_, type, &amp;i, <span class="keyword">sizeof</span>(i));
<a name="l00156"></a>00156         <span class="keywordflow">break</span>;
<a name="l00157"></a>00157       <span class="keywordflow">case</span> ZMQ_SUBSCRIBE: <span class="comment">// continue</span>
<a name="l00158"></a>00158       <span class="keywordflow">case</span> ZMQ_UNSUBSCRIBE:
<a name="l00159"></a>00159         <span class="keywordflow">if</span> (lua_isstring(L, 3)) {
<a name="l00160"></a>00160           str = lua_tolstring(L, 3, &amp;sz);
<a name="l00161"></a>00161         } <span class="keywordflow">else</span> {
<a name="l00162"></a>00162           str = NULL;
<a name="l00163"></a>00163           sz  = 0;
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165         status = zmq_setsockopt(socket_, type, str, sz);
<a name="l00166"></a>00166         <span class="keywordflow">break</span>;
<a name="l00167"></a>00167       <span class="keywordflow">default</span>:
<a name="l00168"></a>00168         <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Could not set socket option: unknown option %i.&quot;</span>, type);
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (status) {
<a name="l00173"></a>00173       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Could not set socket option %i (%s).&quot;</span>, type, str, zmq_strerror(errno));
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176 
<a name="l00180"></a><a class="code" href="classzmq_1_1_socket.html#aba886d2247712d2f85cce98f04960226">00180</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#aba886d2247712d2f85cce98f04960226">bind</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *location) {
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (zmq_bind(socket_, location)) {
<a name="l00182"></a>00182       throw_bind_error(errno, location);
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     location_ = location; <span class="comment">// store last connection for info string</span>
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186 
<a name="l00190"></a><a class="code" href="classzmq_1_1_socket.html#a5bb530a06ae28aed7e9b26094045d541">00190</a>   <span class="keywordtype">int</span> <a class="code" href="classzmq_1_1_socket.html#a5bb530a06ae28aed7e9b26094045d541">bind</a>(<span class="keywordtype">int</span> min_port = 2000, <span class="keywordtype">int</span> max_port = 20000, <span class="keywordtype">int</span> retries = 100) {
<a name="l00191"></a>00191     <span class="comment">// do not use rand() --&gt; not random in higher bits</span>
<a name="l00192"></a>00192     srandom((<span class="keywordtype">unsigned</span>)time(0));
<a name="l00193"></a>00193     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> buf_size = 50;
<a name="l00194"></a>00194     <span class="keywordtype">char</span> <a class="code" href="cv_8h.html#ac9db6ccf8d1a2abfd9a0a162547f9666">buffer</a>[buf_size];
<a name="l00195"></a>00195     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; retries; ++i) {
<a name="l00196"></a>00196       <span class="keywordtype">int</span> port = min_port + (max_port - min_port) * ((<span class="keywordtype">float</span>)random()/RAND_MAX);
<a name="l00197"></a>00197       snprintf(buffer, buf_size, <span class="stringliteral">&quot;tcp://*:%i&quot;</span>, port);
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (!zmq_bind(socket_, buffer)) {
<a name="l00199"></a>00199         <span class="comment">// success</span>
<a name="l00200"></a>00200         location_ = <a class="code" href="cv_8h.html#ac9db6ccf8d1a2abfd9a0a162547f9666">buffer</a>;
<a name="l00201"></a>00201         <span class="keywordflow">return</span> port;
<a name="l00202"></a>00202       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno != EADDRINUSE) {
<a name="l00203"></a>00203         throw_bind_error(errno, <span class="stringliteral">&quot;*&quot;</span>);
<a name="l00204"></a>00204       }
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Could not bind to any port in range &#39;%i-%i&#39; (%i retries).&quot;</span>, min_port, max_port, retries);
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208 
<a name="l00211"></a><a class="code" href="classzmq_1_1_socket.html#a1fb452e66fbc3080430b07b18d53772e">00211</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#a1fb452e66fbc3080430b07b18d53772e">connect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *location) {
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (zmq_connect(socket_, location))
<a name="l00213"></a>00213       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Could not connect to &#39;%s&#39;.&quot;</span>, location);
<a name="l00214"></a>00214     location_ = location; <span class="comment">// store last connection for info string</span>
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216 
<a name="l00221"></a><a class="code" href="classzmq_1_1_socket.html#ae65e9573a8dcc32dc83242aec20a29ec">00221</a>   <span class="keywordtype">bool</span> <a class="code" href="classzmq_1_1_socket.html#ae65e9573a8dcc32dc83242aec20a29ec">hasEvent</a>(<span class="keywordtype">int</span> event) {
<a name="l00222"></a>00222     uint32_t events;
<a name="l00223"></a>00223     <span class="keywordtype">size_t</span> ev_size = <span class="keyword">sizeof</span>(events);
<a name="l00224"></a>00224     <span class="keywordflow">if</span> (zmq_getsockopt(socket_, ZMQ_EVENTS, &amp;events, &amp;ev_size)) {
<a name="l00225"></a>00225       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Error while getting events (%s).&quot;</span>, zmq_strerror(zmq_errno()));
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     <span class="keywordflow">return</span> events &amp; event;
<a name="l00228"></a>00228   }
<a name="l00229"></a>00229 
<a name="l00235"></a><a class="code" href="classzmq_1_1_socket.html#ac9afea253b7419e252a348b06a09fb46">00235</a>   <a class="code" href="lk_2include_2lk_2_socket_8h.html#a038a308a5e7246ac41ca22c43d7209d1">LuaStackSize</a> <a class="code" href="classzmq_1_1_socket.html#ac9afea253b7419e252a348b06a09fb46">recv</a>(lua_State *L) {
<a name="l00236"></a>00236     zmq_msg_t msg;
<a name="l00237"></a>00237     zmq_msg_init(&amp;msg);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (zmq_recv(socket_, &amp;msg, ZMQ_NOBLOCK)) {
<a name="l00240"></a>00240       zmq_msg_close(&amp;msg);
<a name="l00241"></a>00241       <span class="comment">// We always waitRead before we arrive here, so we should never get</span>
<a name="l00242"></a>00242       <span class="comment">// EAGAIN.</span>
<a name="l00243"></a>00243       throw_recv_error(errno);
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordtype">int</span> arg_size = <a class="code" href="msgpack_8h.html#ac85382666450aa97773427832b79652d">msgpack_bin_to_lua</a>(L, zmq_msg_data(&amp;msg), zmq_msg_size(&amp;msg));
<a name="l00247"></a>00247     zmq_msg_close(&amp;msg);
<a name="l00248"></a>00248     <span class="keywordflow">return</span> arg_size;
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250 
<a name="l00255"></a><a class="code" href="classzmq_1_1_socket.html#a8c9e876a842883a8a25c4647ec1039c7">00255</a>   <span class="keywordtype">bool</span> <a class="code" href="classzmq_1_1_socket.html#a8c9e876a842883a8a25c4647ec1039c7">send</a>(lua_State *L) {
<a name="l00256"></a>00256     <a class="code" href="structmsgpack__sbuffer.html">msgpack_sbuffer</a> *<a class="code" href="cv_8h.html#ac9db6ccf8d1a2abfd9a0a162547f9666">buffer</a>;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <a class="code" href="msgpack_8h.html#a1dd8a74096eebc9fda9e552668ce3df1">msgpack_lua_to_bin</a>(L, &amp;buffer, 1);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     zmq_msg_t msg;
<a name="l00261"></a>00261     zmq_msg_init_data(&amp;msg, buffer-&gt;<a class="code" href="structmsgpack__sbuffer.html#a2dc6fcda73b0e59f3dcaa61b7e85837d">data</a>, buffer-&gt;<a class="code" href="structmsgpack__sbuffer.html#a7779f75edb79f38b4f987e04985011f3">size</a>, <a class="code" href="msgpack_8h.html#acb585ec742d4be93f13cc8731f734d28">free_msgpack_msg</a>, buffer);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (zmq_send(socket_, &amp;msg, send_flags_)) {
<a name="l00264"></a>00264       zmq_msg_close(&amp;msg);
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (errno == EAGAIN) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00266"></a>00266       throw_send_error(errno);
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268     zmq_msg_close(&amp;msg);
<a name="l00269"></a>00269     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271 
<a name="l00275"></a><a class="code" href="classzmq_1_1_socket.html#adb9c798cb32e1b4b2a1488f6d509adc1">00275</a>   <span class="keywordtype">bool</span> <a class="code" href="classzmq_1_1_socket.html#adb9c798cb32e1b4b2a1488f6d509adc1">rawSend</a>(lua_State *L) {
<a name="l00276"></a>00276     <span class="keywordtype">size_t</span> <a class="code" href="cv_8h.html#a854352f53b148adc24983a58a1866d66">size</a>;
<a name="l00277"></a>00277     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cv_8h.html#acd1647952fba31484ea63d6f1140e509">data</a> = lua_tolstring(L, -1, &amp;size);
<a name="l00278"></a>00278     zmq_msg_t msg;
<a name="l00279"></a>00279     zmq_msg_init_data(&amp;msg, (<span class="keywordtype">void</span>*)data, size, NULL, NULL);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (zmq_send(socket_, &amp;msg, send_flags_)) {
<a name="l00282"></a>00282       zmq_msg_close(&amp;msg);
<a name="l00283"></a>00283       <span class="keywordflow">if</span> (errno == EAGAIN) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00284"></a>00284       throw_send_error(errno);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     zmq_msg_close(&amp;msg);
<a name="l00287"></a>00287     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00288"></a>00288   }
<a name="l00289"></a>00289 
<a name="l00292"></a><a class="code" href="classzmq_1_1_socket.html#a9d6e15efa968134db3ceaf2c6516f4ad">00292</a>   <a class="code" href="lk_2include_2lk_2_socket_8h.html#a038a308a5e7246ac41ca22c43d7209d1">LuaStackSize</a> <a class="code" href="classzmq_1_1_socket.html#a9d6e15efa968134db3ceaf2c6516f4ad">request</a>(lua_State *L) {
<a name="l00293"></a>00293     <span class="keywordtype">bool</span> timed_out = <span class="keyword">false</span>;
<a name="l00294"></a>00294     <a class="code" href="structmsgpack__sbuffer.html">msgpack_sbuffer</a> *<a class="code" href="cv_8h.html#ac9db6ccf8d1a2abfd9a0a162547f9666">buffer</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <a class="code" href="msgpack_8h.html#a1dd8a74096eebc9fda9e552668ce3df1">msgpack_lua_to_bin</a>(L, &amp;buffer, 1);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     zmq_msg_t msg;
<a name="l00299"></a>00299     zmq_msg_t recv_msg;
<a name="l00300"></a>00300     zmq_msg_init_data(&amp;msg, buffer-&gt;<a class="code" href="structmsgpack__sbuffer.html#a2dc6fcda73b0e59f3dcaa61b7e85837d">data</a>, buffer-&gt;<a class="code" href="structmsgpack__sbuffer.html#a7779f75edb79f38b4f987e04985011f3">size</a>, <a class="code" href="msgpack_8h.html#acb585ec742d4be93f13cc8731f734d28">free_msgpack_msg</a>, buffer);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">//  Initialize poll set</span>
<a name="l00303"></a>00303     zmq_pollitem_t items[] = {
<a name="l00304"></a>00304         { socket_,    0, ZMQ_POLLIN, 0 }
<a name="l00305"></a>00305     };
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (zmq_send(socket_, &amp;msg, send_flags_)) {
<a name="l00308"></a>00308       zmq_msg_close(&amp;msg);
<a name="l00309"></a>00309       <span class="comment">// TODO: EAGAIN</span>
<a name="l00310"></a>00310       throw_send_error(errno);
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     zmq_msg_close(&amp;msg);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     zmq_msg_init(&amp;recv_msg);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordtype">double</span> <a class="code" href="cvaux_8h.html#a7e7356db167a8b78d03c01efc265b638">start</a> = time_ref_.elapsed();
<a name="l00319"></a>00319     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">long</span> total_timeout = 200000;
<a name="l00320"></a>00320     <span class="keywordtype">long</span> timeout = total_timeout;
<a name="l00321"></a>00321     <span class="comment">// Receive with (relatively short) timeout</span>
<a name="l00322"></a>00322     <span class="comment">// [us] = 200ms</span>
<a name="l00323"></a>00323     <span class="keywordflow">while</span> (1) {
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (zmq_poll(items, 1, timeout) == -1) {
<a name="l00325"></a>00325         zmq_msg_close(&amp;recv_msg);
<a name="l00326"></a>00326         throw_poll_error(errno);
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="keywordflow">if</span> (!items[0].revents &amp; ZMQ_POLLIN) {
<a name="l00330"></a>00330         <span class="comment">// timeout: no message</span>
<a name="l00331"></a>00331         <span class="keywordtype">double</span> now = time_ref_.elapsed();
<a name="l00332"></a>00332         <span class="keywordflow">if</span> (now &gt;= start + total_timeout/1000) {
<a name="l00333"></a>00333           timed_out = <span class="keyword">true</span>;
<a name="l00334"></a>00334           <span class="keywordflow">break</span>;
<a name="l00335"></a>00335         } <span class="keywordflow">else</span> {
<a name="l00336"></a>00336           <span class="comment">// poll can return before total_timeout</span>
<a name="l00337"></a>00337           <span class="comment">// wait the rest of the timeout</span>
<a name="l00338"></a>00338           timeout = total_timeout - (now - <a class="code" href="cvaux_8h.html#a7e7356db167a8b78d03c01efc265b638">start</a>);
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340       } <span class="keywordflow">else</span> {
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (zmq_recv(socket_, &amp;recv_msg, 0)) {
<a name="l00342"></a>00342           zmq_msg_close(&amp;recv_msg);
<a name="l00343"></a>00343           throw_recv_error(errno);
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345         <span class="keywordflow">break</span>;
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (timed_out) {
<a name="l00350"></a>00350       lua_pushnil(L);
<a name="l00351"></a>00351       <span class="keywordflow">return</span> 1;
<a name="l00352"></a>00352     } <span class="keywordflow">else</span> {
<a name="l00353"></a>00353       <span class="keywordtype">int</span> arg_size = <a class="code" href="msgpack_8h.html#ac85382666450aa97773427832b79652d">msgpack_bin_to_lua</a>(L, zmq_msg_data(&amp;recv_msg), zmq_msg_size(&amp;recv_msg));
<a name="l00354"></a>00354       zmq_msg_close(&amp;recv_msg);
<a name="l00355"></a>00355       <span class="keywordflow">return</span> arg_size;
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357   }
<a name="l00358"></a>00358 
<a name="l00359"></a><a class="code" href="classzmq_1_1_socket.html#a2db0d2f61412a6acaa0ba92bf12dd942">00359</a>   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classzmq_1_1_socket.html#a2db0d2f61412a6acaa0ba92bf12dd942">location</a>() {
<a name="l00360"></a>00360     <span class="keywordflow">return</span> location_.c_str();
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362 
<a name="l00363"></a><a class="code" href="classzmq_1_1_socket.html#a283c0ffa93cb186a8de58739b0eef914">00363</a>   <span class="keywordtype">int</span> <a class="code" href="classzmq_1_1_socket.html#a283c0ffa93cb186a8de58739b0eef914">port</a>() {
<a name="l00364"></a>00364     <span class="keywordtype">size_t</span> <a class="code" href="cxcore_8h.html#a6492959798ef439146ab2816fe754d81">pos</a> = location_.rfind(<span class="stringliteral">&quot;:&quot;</span>);
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (pos != std::string::npos) {
<a name="l00366"></a>00366       <span class="keywordflow">return</span> atoi(location_.substr(pos + 1).c_str());
<a name="l00367"></a>00367     } <span class="keywordflow">else</span> {
<a name="l00368"></a>00368       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Could not get port from localtion &#39;%s&#39;.&quot;</span>, location_.c_str());
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370   }
<a name="l00371"></a>00371 
<a name="l00374"></a><a class="code" href="classzmq_1_1_socket.html#afffa4ad08098ae2356b42efa851b5e1f">00374</a>   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classzmq_1_1_socket.html#afffa4ad08098ae2356b42efa851b5e1f">type</a>()<span class="keyword"> const </span>{
<a name="l00375"></a>00375     <span class="keywordflow">switch</span>(type_) {
<a name="l00376"></a>00376       <span class="keywordflow">case</span> ZMQ_PAIR: <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.PAIR&quot;</span>;
<a name="l00377"></a>00377       <span class="keywordflow">case</span> ZMQ_PUB : <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.PUB&quot;</span> ;
<a name="l00378"></a>00378       <span class="keywordflow">case</span> ZMQ_SUB : <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.SUB&quot;</span> ;
<a name="l00379"></a>00379       <span class="keywordflow">case</span> ZMQ_REQ : <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.REQ&quot;</span> ;
<a name="l00380"></a>00380       <span class="keywordflow">case</span> ZMQ_REP : <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.REP&quot;</span> ;
<a name="l00381"></a>00381       <span class="keywordflow">case</span> ZMQ_XREQ: <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.XREQ&quot;</span>;
<a name="l00382"></a>00382       <span class="keywordflow">case</span> ZMQ_XREP: <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.XREP&quot;</span>;
<a name="l00383"></a>00383       <span class="keywordflow">case</span> ZMQ_PULL: <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.PULL&quot;</span>;
<a name="l00384"></a>00384       <span class="keywordflow">case</span> ZMQ_PUSH: <span class="keywordflow">return</span> <span class="stringliteral">&quot;zmq.PUSH&quot;</span>;
<a name="l00385"></a>00385       <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;???&quot;</span>;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387   }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 <span class="keyword">private</span>:
<a name="l00390"></a>00390 
<a name="l00391"></a><a class="code" href="classzmq_1_1_socket.html#a006ba13cc78ab465f381d84223db097b">00391</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#a006ba13cc78ab465f381d84223db097b">throw_bind_error</a>(<span class="keywordtype">int</span> err, <span class="keyword">const</span> <span class="keywordtype">char</span> *location) {
<a name="l00392"></a>00392     <span class="keywordflow">switch</span>(err) {
<a name="l00393"></a>00393     <span class="keywordflow">case</span> EPROTONOSUPPORT:
<a name="l00394"></a>00394       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The requested transport protocol is not supported (%s).&quot;</span>, location);
<a name="l00395"></a>00395     <span class="keywordflow">case</span> ENOCOMPATPROTO:
<a name="l00396"></a>00396       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The requested transport protocol (%s) is not compatible with the socket type (%s).&quot;</span>, location, <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>());
<a name="l00397"></a>00397     <span class="keywordflow">case</span> EADDRINUSE:
<a name="l00398"></a>00398       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The requested address is already in use (%s).&quot;</span>, location);
<a name="l00399"></a>00399     <span class="keywordflow">case</span> EADDRNOTAVAIL:
<a name="l00400"></a>00400       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The requested address was not local (%s).&quot;</span>, location);
<a name="l00401"></a>00401     <span class="keywordflow">case</span> ENODEV:
<a name="l00402"></a>00402       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The requested address specifies a nonexistent interface (%s). Did you mean connect ?.&quot;</span>, location);
<a name="l00403"></a>00403     <span class="keywordflow">case</span> ETERM:
<a name="l00404"></a>00404       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The ZMQ context associated with the specified socket was terminated (%s).&quot;</span>, location);
<a name="l00405"></a>00405     <span class="keywordflow">case</span> EFAULT: <span class="comment">// continue</span>
<a name="l00406"></a>00406     <span class="keywordflow">default</span>:
<a name="l00407"></a>00407       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The provided socket was not valid (%s).&quot;</span>, location);
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409   }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="classzmq_1_1_socket.html#abf9a79140e1b334387bb8962ae87b18b">00411</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#abf9a79140e1b334387bb8962ae87b18b">throw_recv_error</a>(<span class="keywordtype">int</span> err) {
<a name="l00412"></a>00412     <span class="keywordflow">switch</span>(err) {
<a name="l00413"></a>00413     <span class="keywordflow">case</span> EAGAIN:
<a name="l00414"></a>00414       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Non-blocking mode was requested and no messages are available at the moment.&quot;</span>);
<a name="l00415"></a>00415     <span class="keywordflow">case</span> ENOTSUP:
<a name="l00416"></a>00416       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The zmq_recv() operation is not supported by this socket type (%s).&quot;</span>, <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>());
<a name="l00417"></a>00417     <span class="keywordflow">case</span> EFSM:
<a name="l00418"></a>00418       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The zmq_recv() operation cannot be performed on this socket at the moment due to the socket not being in the appropriate state. This error may occur with socket types that switch between several states, such as ZMQ_REP (%s).&quot;</span>, <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>());
<a name="l00419"></a>00419     <span class="keywordflow">case</span> ETERM:
<a name="l00420"></a>00420       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The ZMQ context associated with the specified socket was terminated.&quot;</span>);
<a name="l00421"></a>00421     <span class="keywordflow">case</span> EFAULT: <span class="comment">// continue</span>
<a name="l00422"></a>00422     <span class="keywordflow">default</span>:
<a name="l00423"></a>00423       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The provided context was not valid (NULL).&quot;</span>);
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425   }
<a name="l00426"></a>00426 
<a name="l00427"></a><a class="code" href="classzmq_1_1_socket.html#a2004a53949cd7211ef1d2c0a8855d7bb">00427</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#a2004a53949cd7211ef1d2c0a8855d7bb">throw_poll_error</a>(<span class="keywordtype">int</span> err) {
<a name="l00428"></a>00428     <span class="keywordflow">switch</span>(err) {
<a name="l00429"></a>00429     <span class="keywordflow">case</span> ETERM:
<a name="l00430"></a>00430       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;At least one of the members of the items array refers to a socket whose associated ØMQ context was terminated.&quot;</span>);
<a name="l00431"></a>00431     <span class="keywordflow">case</span> EFAULT:
<a name="l00432"></a>00432       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;At least one of the members of the items array refers to a socket belonging to a different application thread.&quot;</span>);
<a name="l00433"></a>00433     <span class="keywordflow">default</span>:
<a name="l00434"></a>00434       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The provided context was not valid (NULL).&quot;</span>);
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436   }
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="classzmq_1_1_socket.html#aefd91d4db525ae071c63bf201798e8bc">00438</a>   <span class="keywordtype">void</span> <a class="code" href="classzmq_1_1_socket.html#aefd91d4db525ae071c63bf201798e8bc">throw_send_error</a>(<span class="keywordtype">int</span> err) {
<a name="l00439"></a>00439     <span class="keywordflow">switch</span>(err) {
<a name="l00440"></a>00440     <span class="keywordflow">case</span> EAGAIN:
<a name="l00441"></a>00441       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;Non-blocking mode was requested and the message cannot be sent at the moment.&quot;</span>);
<a name="l00442"></a>00442     <span class="keywordflow">case</span> ENOTSUP:
<a name="l00443"></a>00443       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The zmq_send() operation is not supported by this socket type (%s).&quot;</span>, <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>());
<a name="l00444"></a>00444     <span class="keywordflow">case</span> EFSM:
<a name="l00445"></a>00445       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The zmq_send() operation cannot be performed on this socket at the moment due to the socket not being in the appropriate state. This error may occur with socket types that switch between several states, such as ZMQ_REP (%s).&quot;</span>, <a class="code" href="cv_8h.html#a8bc957583d2a5247e490ea9ce960cf21">type</a>());
<a name="l00446"></a>00446     <span class="keywordflow">case</span> ETERM:
<a name="l00447"></a>00447       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The ZMQ context associated with the specified socket was terminated.&quot;</span>);
<a name="l00448"></a>00448     <span class="keywordflow">case</span> EFAULT: <span class="comment">// continue</span>
<a name="l00449"></a>00449     <span class="keywordflow">default</span>:
<a name="l00450"></a>00450       <span class="keywordflow">throw</span> <a class="code" href="classlubyk_1_1_exception.html">Exception</a>(<span class="stringliteral">&quot;The provided context was not valid (NULL).&quot;</span>);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453 };
<a name="l00454"></a>00454 } <span class="comment">// zmq</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="preprocessor">#endif // LUBYK_INCLUDE_ZMQ_SOCKET_H_</span>
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu Dec 8 2011 15:43:32 for lubyk by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
